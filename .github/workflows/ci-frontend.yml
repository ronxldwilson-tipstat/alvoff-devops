name: CI - Build & Push Frontend Docker Image

on:
  workflow_call:
    outputs:
      IMAGE_TAG:
        description: "Docker image tag (short SHA)"
        value: ${{ jobs.build.outputs.IMAGE_TAG }}
    inputs:
      repo_name:
        description: 'Repository name (used as Docker image name)'
        required: true
        type: string
      docker_org:
        description: 'Docker Hub organization'
        required: false
        type: string
        default: 'tipstatinc'
      platform:
        description: 'Docker build platform'
        required: false
        type: string
        default: 'linux/arm64'
      environment:
        description: 'Deployment environment (development, staging, production)'
        required: true
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.vars.outputs.IMAGE_TAG }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set build variables
        id: vars
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Image tag: ${SHORT_SHA}"

      - name: Set environment file
        run: |
          ENV_FILE=".env.${{ inputs.environment }}"
          if [ -f "$ENV_FILE" ]; then
            cp "$ENV_FILE" .env
            echo "Using $ENV_FILE as .env"
          else
            echo "ERROR: $ENV_FILE not found!"
            exit 1
          fi

      - name: Setup QEMU (for cross-platform builds)
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: ${{ inputs.platform }}
          tags: |
            ${{ inputs.docker_org }}/${{ inputs.repo_name }}:${{ steps.vars.outputs.IMAGE_TAG }}
            ${{ inputs.docker_org }}/${{ inputs.repo_name }}:latest
          cache-from: type=registry,ref=${{ inputs.docker_org }}/${{ inputs.repo_name }}:latest
          cache-to: type=inline
